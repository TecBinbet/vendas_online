<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Venda</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald Green
                        'secondary': '#10B981', // Green
                        'danger': '#EF4444',
                        'modal-bg': '#F0FFF4', // Fundo leve para modal
                        'active-border': '#10B981', // Borda ativa do card
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F7F7F7; }
        .container { max-width: 90%; margin: 20px auto; padding: 20px; background-color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .alert-danger { background-color: #FEE2E2; color: #991B1B; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #FCA5A5; }
        .alert-success { background-color: #D1FAE5; color: #065F46; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #6EE7B7; }
        .alert-info { background-color: #DBEAFE; color: #1E40AF; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #93C5FD; }
        .form-group label { font-weight: 600; display: block; margin-bottom: 5px; color: #374151; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        
        .btn-primary { background-color: #059669; color: white; border: none; }
        .btn-primary:hover { background-color: #047857; }
        .btn-warning { background-color: #25D366; color: white; border: none; }
        .btn-warning:hover { background-color: #1DA851; }
        .btn-small { padding: 6px 12px; font-size: 0.9rem; }

        .client-search-group { display: flex; gap: 8px; margin-bottom: 0; position: relative; } /* relative para a lista absoluta */
        .client-search-group input { flex-grow: 1; margin-bottom: 0; }
        .client-search-group .btn-small { width: auto; flex-shrink: 0; padding: 10px 15px; margin-bottom: 0; font-size: 0.9rem; }
        
        .btn-novo { background-color: #FFC107; color: #333; }
        .btn-novo:hover { background-color: #e0a800; }

        #receipt-content { background-color: white !important; padding: 15px; border: 1px dashed #38B2AC; border-radius: 8px; margin-bottom: 15px; color: #065F46; white-space: pre-wrap; font-family: monospace; text-align: left; }
        #total-custo { font-size: 1.25rem; font-weight: 700; color: #B91C1C; margin-top: 15px; padding: 10px; border: 2px solid #FCA5A5; border-radius: 8px; text-align: center; }

        /* Estilos da Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #F0FFF4; max-width: 95%; max-height: 90%; 
            padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        .event-card {
            background-color: white; border: 2px solid transparent; 
            border-radius: 8px; padding: 15px; cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .event-card:hover { border-color: #A7F3D0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }

        /* --- CSS DA LISTA DE RESULTADOS DE BUSCA (NOVO) --- */
        #search-results-list {
            position: absolute;
            top: 100%; /* Logo abaixo do input */
            left: 0;
            right: 0; /* Mesma largura do container pai */
            background: white;
            border: 1px solid #D1D5DB;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Come√ßa oculto */
        }
        
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #F3F4F6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: #F0FDF4; } /* Verde claro */
        
        .search-type-selector {
            display: flex; gap: 15px; margin-bottom: 8px; font-size: 0.9rem; color: #4B5563;
        }
        .search-type-selector label { font-weight: normal; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="text-2xl font-bold mb-1 text-gray-900 text-center">‚≠ê Nova Venda</h2>

        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        
        {% if success %}
            <!-- Bloco de Sucesso (Mantido igual) -->
            <div class="alert alert-success text-center">
                <h3 class="text-xl font-bold mb-2">Venda Registrada com Sucesso!</h3>
                <div id="receipt-content">{{ success | safe }}</div>
            </div>
            <div class="flex justify-center mb-2 gap-3 flex-wrap">
                <button onclick="copyReceiptText()" class="btn btn-primary shadow-lg">üìã Copiar Texto</button>
                <button onclick="shareReceiptImage()" class="btn btn-warning shadow-lg">üñºÔ∏è Gerar Imagem</button>
            </div>
        {% endif %}

        {% if not g.db_status %}
             <div class="alert alert-danger">DB OFFLINE. Vendas n√£o podem ser processadas.</div>
        {% endif %}
        
        <form method="GET" action="{{ url_for('nova_venda') }}" class="form-venda" id="main-form">
            
            <input type="hidden" name="id_evento" id="input_id_evento" 
                   value="{% if selected_event %}{{ selected_event._id }}{% endif %}">
            
            <div class="form-group flex gap-1 items-center">
                <div >
                    <label for="evento_display">1. Evento >>></label>
                    <input type=""hidden text" id="evento_display" readonly class="text-[9px] font-bold form-control bg-gray-100"
                        value="{% if selected_event %}{{ selected_event.descricao }} {% else %}-- Selecione um Evento Ativo --{% endif %}"
                    >
                </div>
                <button type="button" onclick="openEventSelector()" 
                        class="btn btn-primary btn-small self-end mb-3 min-w-[120px]">
                    Selecionar o Evento
                </button>
            </div>

            {% if selected_event %}
                <div class="alert alert-info mt-0 mb-1" style="margin-top: 1px;">
                    <h4 class="text-lg font-bold">{{ selected_event.descricao }}</h4>
                    <p>Data: <strong>{{ selected_event.data_evento }}</strong> | Hora: <strong>{{ selected_event.hora_evento }}</strong></p>
                    <p>Valor Kit: <strong>R$ {{ "%.2f" | format(selected_event.valor_de_venda_float) }}</strong> X Crtlas p/ kit: <strong>{{ selected_event.unidade_de_venda }}</strong></p>
                    <p>N√∫m. In√≠cial: <strong>{{ selected_event.numero_inicial }}</strong> | N√∫m. Atual:  <strong>{{ selected_event.numeracao_atual_display }}</strong></p>
                </div>
            {% endif %}

            {% if selected_event %}
                <div class="form-group relative">
                    <label for="id_cliente_busca">2. Cliente ( Buscar ):</label>
                    
                    <!-- SELETOR DE TIPO DE BUSCA (NOVO) -->
                    <div class="search-type-selector">
                        <label><input type="radio" name="search_type" value="nick" checked onchange="clearSearch()"> Nick (Apelido)</label>
                        <label><input type="radio" name="search_type" value="nome" onchange="clearSearch()"> Nome</label>
                        <label><input type="radio" name="search_type" value="id" onchange="clearSearch()"> ID</label>
                    </div>

                    <div class="client-search-group font-bold">
                        <!-- INPUT DE BUSCA COM EVENTO DE DIGITA√á√ÉO -->
                        <input type="text" id="id_cliente_busca" name="id_cliente_busca" 
                               value="{{ cliente_busca | default('') }}" 
                               placeholder="Digite para buscar..." 
                               class="form-control"
                               autocomplete="off"
                               onkeyup="handleSearchInput(this)">
                        
                        <!-- Link para novo cadastro (mantido) -->
                        <a href="{{ url_for('cadastro_cliente', view='novo', next='nova_venda') }}" class="btn btn-novo btn-small" style="text-decoration: none; display: flex; align-items: center;">
                            ‚ûï Novo
                        </a>
                        
                        <!-- LISTA DE RESULTADOS FLUTUANTE (NOVO) -->
                        <div id="search-results-list"></div>
                    </div>
                </div>

                <!-- Resultado da sele√ß√£o (Cliente encontrado) -->
                {% if cliente_encontrado %}
                    <div class="alert alert-success mt-1">
                        Selecionado: <strong>{{ cliente_encontrado.nick }}</strong> ({{ cliente_encontrado.nome_cliente }}) - ID: <strong>CLI{{ id_cliente_final }}</strong>
                        <input type="hidden" name="id_cliente_final" id="id_cliente_final_hidden" value="{{ id_cliente_final }}">
                    </div>
                {% elif cliente_busca and not cliente_encontrado %}
                    <!-- Este alerta aparece se o backend n√£o achou nada via submit tradicional (fallback) -->
                    <div class="alert alert-warning mt-1 alert-info">Cliente '{{ cliente_busca }}' n√£o encontrado.</div>
                {% else %}
                    <!-- Campo hidden vazio se nenhum cliente selecionado -->
                    <input type="hidden" name="id_cliente_final" id="id_cliente_final_hidden" value="">
                {% endif %}

                <div class="form-group mt-1">
                    <label for="quantidade">3. Quantidade de Unidades:</label>
                    <input type="number" id="quantidade" name="quantidade" 
                           value="{{ quantidade | default(1) }}" min="1" required 
                           class="form-control" 
                           oninput="updateTotalCost(); updateCartelasDisplay();">
                    <small class="form-text text-muted font-bold">Total de cartelas: 
                        <span id="cartelas-display">
                            {{ (quantidade * selected_event.unidade_de_venda) if quantidade > 0 and selected_event else 0 }}
                        </span>.
                    </small>
                </div>
               
                <div id="total-custo" class="mt-1">
                    Custo Total: R$ {{ "%.2f" | format(custo) }} 
                </div>

            {% endif %}
        </form>

        {% if cliente_encontrado and quantidade > 0 and selected_event %}
            <hr class="my-4 border-gray-300">
            <form method="POST" action="{{ url_for('processar_venda') }}" class="flex justify-center" id="confirm-form">
                <input type="hidden" name="id_cliente_final" id="post_id_cliente_final" value="{{ id_cliente_final }}">
                <input type="hidden" name="id_evento" id="post_id_evento" value="{{ selected_event._id }}">
                <input type="hidden" name="quantidade" id="post_quantidade" value="{{ quantidade }}">
                
                <button type="submit" id="btn-confirmar-venda" class="btn btn-primary btn-lg shadow-xl hover:shadow-2xl transition duration-300" 
                     onclick="return syncAndConfirm(event)">
                    ‚úÖ Confirmar e Gravar Venda (<span id="btn-custo-text">R$ {{ "%.2f" | format(custo) }}</span>)
                </button>
            </form>
        {% endif %}

        <div class="flex justify-center font-bold mt-4">
            <a href="{{ url_for('menu_operacoes') }}" class="text-primary hover:text-secondary font-medium">‚Üê Voltar ao Menu de Opera√ß√µes</a>
        </div>
    </div>
    
    <!-- MODAL DE EVENTOS (Mantida igual) -->
    <div id="event-selector-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <h3 class="text-xl font-bold mb-1 text-gray-700 border-b pb-1">Selecione o Evento Ativo</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-130 overflow-y-auto pr-2">
                {% for evento in eventos %}
                    <div class="event-card shadow-md flex flex-col justify-between"
                        data-id="{{ evento._id }}"
                        data-descricao="{{ evento.descricao }}"
                        data-valor="{{ '%.2f' | format(evento.valor_de_venda_float) }}"
                        data-unidade="{{ evento.unidade_de_venda }}"
                        onclick="selectEvent(this)">
                        <div>
                            <p class="text-md font-bold text-primary">{{ evento.descricao }} (EVE{{ evento.id_evento }})</p>
                            <div class="mt-2 text-md font-semibold">
                                <p>üí∞ R$ {{ '%.2f' | format(evento.valor_de_venda_float) }} / Unidade</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-2 border-t border-dashed">
                            <button class="btn btn-primary btn-small w-full mt-2">Selecionar</button>
                        </div>
                    </div>
                {% else %}
                    <p class="text-center text-gray-500 md:col-span-2">Nenhum evento ativo.</p>
                {% endfor %}
            </div>
            <button onclick="closeEventSelector()" class="btn bg-gray-400 text-white hover:bg-gray-500 mt-4 w-full">Fechar</button>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let Venda_ValorUnitario = parseFloat("{{ selected_event.valor_de_venda_float | default('0.0') }}");
        let Venda_UnidadeCartelas = parseInt("{{ selected_event.unidade_de_venda | default('0') }}");
        let searchTimeout = null; // Para o debounce

        // --- L√ìGICA DE BUSCA DIN√ÇMICA (NOVO) ---

        function handleSearchInput(inputElement) {
            const termo = inputElement.value.trim();
            const resultsDiv = document.getElementById('search-results-list');
            
            // 1. Limpa o timeout anterior (debounce)
            if (searchTimeout) clearTimeout(searchTimeout);

            // 2. Se vazio ou muito curto, esconde a lista
            if (termo.length < 2) {
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                return;
            }

            // 3. Define um novo timeout para buscar ap√≥s 400ms de inatividade
            searchTimeout = setTimeout(() => {
                executarBusca(termo);
            }, 400);
        }
        
        function getSearchType() {
            const radios = document.getElementsByName('search_type');
            for (let radio of radios) {
                if (radio.checked) return radio.value;
            }
            return 'nick'; // Fallback
        }
        
        function clearSearch() {
             document.getElementById('id_cliente_busca').value = '';
             document.getElementById('search-results-list').style.display = 'none';
        }

        async function executarBusca(termo) {
            const tipo = getSearchType();
            const resultsDiv = document.getElementById('search-results-list');
            
            // Feedback de carregamento
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="p-2 text-gray-500 text-center">Buscando...</div>';

            try {
                const response = await fetch(`/buscar_clientes?termo=${encodeURIComponent(termo)}&tipo=${tipo}`);
                const data = await response.json();

                resultsDiv.innerHTML = ''; // Limpa

                if (data.clientes && data.clientes.length > 0) {
                    data.clientes.forEach(cli => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        // Conte√∫do da linha
                        div.innerHTML = `
                            <div class="font-bold text-gray-800">${cli.nick || cli.nome}</div>
                            <div class="text-sm text-gray-600">ID: ${cli.id} | ${cli.nome} | ${cli.cidade}</div>
                        `;
                        
                        // Ao clicar, seleciona o cliente
                        div.onclick = () => selecionarCliente(cli);
                        
                        resultsDiv.appendChild(div);
                    });
                } else {
                    resultsDiv.innerHTML = '<div class="p-2 text-gray-500 text-center">Nenhum cliente encontrado.</div>';
                }
            } catch (err) {
                console.error(err);
                resultsDiv.innerHTML = '<div class="p-2 text-red-500 text-center">Erro na busca.</div>';
            }
        }

        function selecionarCliente(cliente) {
            // 1. Preenche o input visual com o texto da busca (ou nick)
            const inputBusca = document.getElementById('id_cliente_busca');
            inputBusca.value = cliente.nick || cliente.nome; 
            
            // 2. Esconde a lista
            document.getElementById('search-results-list').style.display = 'none';
            
            // 3. Dispara o SUBMIT do formul√°rio (GET) para recarregar a p√°gina
            //    Isso far√° o backend renderizar a p√°gina com o cliente selecionado (alert verde, etc.)
            //    Para isso, precisamos garantir que o valor enviado seja algo que o backend entenda.
            //    Como o backend busca por ID se tiver "CLI" ou d√≠gitos, vamos for√ßar o ID.
            
            inputBusca.value = `CLI${cliente.id}`; // For√ßa o formato de ID para busca exata
            document.getElementById('main-form').submit();
        }

        // --- Fun√ß√µes Existentes (Mantidas) ---

        function cleanAndParseFloat(valueString) {
            if (!valueString) return 0;
            let cleaned = valueString.replace(/[^0-9,\.]/g, ''); 
            if (cleaned.includes(',')) {
                cleaned = cleaned.replace(/\./g, ''); 
                cleaned = cleaned.replace(',', '.'); 
            }
            return parseFloat(cleaned);
        }

        function updateTotalCost() {
            const campoQuantidade = document.getElementById('quantidade');
            const elementoCustoTotal = document.getElementById('total-custo');
            const spanBotaoCusto = document.getElementById('btn-custo-text');
            const inputPostQuantidade = document.getElementById('post_quantidade');

            if (campoQuantidade && elementoCustoTotal) {
                const quantidade = parseInt(campoQuantidade.value) || 0;
                const total = quantidade * Venda_ValorUnitario;
                const totalFormatado = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                elementoCustoTotal.textContent = `Custo Total: ${totalFormatado}`;
                if (spanBotaoCusto) spanBotaoCusto.textContent = totalFormatado;
                if (inputPostQuantidade) inputPostQuantidade.value = quantidade;
            }
        }
        
        function updateCartelasDisplay() {
            const campoQuantidade = document.getElementById('quantidade');
            const displayCartelas = document.getElementById('cartelas-display');
            if (campoQuantidade && displayCartelas) {
                const quantidade = parseInt(campoQuantidade.value) || 0;
                displayCartelas.textContent = (quantidade * Venda_UnidadeCartelas);
            }
        }

        function openEventSelector() { document.getElementById('event-selector-modal').style.display = 'flex'; }
        function closeEventSelector() { document.getElementById('event-selector-modal').style.display = 'none'; }
        
        function selectEvent(cardElement) {
            const eventId = cardElement.dataset.id;
            const descricao = cardElement.dataset.descricao;
            const valor = cleanAndParseFloat(cardElement.dataset.valor);
            const unidade = parseInt(cardElement.dataset.unidade) || 0;
            const valorFormatado = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            document.getElementById('input_id_evento').value = eventId;
            document.getElementById('evento_display').value = `${descricao} (${valorFormatado})`;
            Venda_ValorUnitario = valor;
            Venda_UnidadeCartelas = unidade;
            closeEventSelector();
            document.getElementById('main-form').submit();
        }
        
        function syncAndConfirm(event) {
            event.preventDefault(); 
            const confirmou = window.confirm("Voc√™ tem certeza que deseja gravar esta venda?");
            if (!confirmou) return false;

            const button = document.getElementById('btn-confirmar-venda');
            if (button.disabled) return false; 

            button.disabled = true;
            button.style.cursor = 'wait';
            button.classList.add('opacity-50'); 
            button.innerHTML = '‚è≥ Processando...';

            const form = document.getElementById('confirm-form');
            if (form) {
                form.submit(); 
            } else {
                alert("Erro cr√≠tico: Formul√°rio n√£o encontrado.");
                button.disabled = false; 
                button.innerHTML = '‚ùå Erro!';
            }
            return false;
        }

        function copyReceiptText() {
            const receiptDiv = document.getElementById('receipt-content');
            if (!receiptDiv) return;
            
            const textToCopy = receiptDiv.innerText.trim(); 
            
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                // Chama o WhatsApp automaticamente ap√≥s copiar
                abrirWhatsApp(textToCopy);
            } catch (err) {
                alert('Erro ao copiar texto.');
            }
            
            document.body.removeChild(tempTextArea);
        }

        // --- NOVA FUN√á√ÉO: ABRIR WHATSAPP ---
        function abrirWhatsApp(textoParaEnviar) {
           // DEBUG: Vamos ver o que o Python escreveu aqui
           // Se cliente_encontrado for None, vai escrever 'VAZIO'
           var debugRaw = "{{ cliente_encontrado.telefone if cliente_encontrado else 'VAZIO' }}";
           console.log("1. Valor bruto vindo do Python:", debugRaw);

           var rawTelefone = "{{ cliente_encontrado.telefone | default('') if cliente_encontrado else '' }}";
           console.log("2. Vari√°vel rawTelefone:", rawTelefone);

           var telefone = rawTelefone.replace(/\D/g, '');
           console.log("3. Telefone limpo (apenas n√∫meros):", telefone);
         
           // Se tiver n√∫mero v√°lido, adiciona c√≥digo pa√≠s
           if (telefone && telefone.length > 0) {
               if (telefone.length <= 11) {
                   telefone = "55" + telefone;
               }
           } else {
               telefone = "";
               console.warn("AVISO: Telefone ficou vazio ap√≥s limpeza.");
           }
 
           console.log("4. Telefone Final para URL:", telefone);

           var mensagem = textoParaEnviar || "";
           var mensagemCodificada = encodeURIComponent(mensagem);

           var url = "https://wa.me/" + telefone + "?text=" + mensagemCodificada;
            
           console.log("5. Abrindo URL:", url);
           window.open(url, '_blank');
        }
        
        function shareReceiptImage() {
            // ... (C√≥digo de imagem mantido)
             const receiptDiv = document.getElementById('receipt-content');
            if (!receiptDiv) return;
            html2canvas(receiptDiv, { scale: 2, useCORS: true, backgroundColor: '#FFFFFF' }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const w = window.open('about:blank');
                w.document.write(`<img src="${imgData}"/>`);
            });
        }

        window.addEventListener('pageshow', (event) => {
            const button = document.getElementById('btn-confirmar-venda');
            if (event.persisted && button && button.disabled) {
                button.disabled = false;
                button.style.cursor = 'pointer';
                button.classList.remove('opacity-50');
                // Texto idealmente seria restaurado aqui
                button.innerHTML = `‚úÖ Confirmar`; 
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateTotalCost();
            updateCartelasDisplay();
        });
    </script>
</body>
</html>