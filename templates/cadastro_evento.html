<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Eventos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669',
                        'secondary': '#10B981',
                        'accent': '#F59E0B', // Amber
                        'danger': '#EF4444',
                        'info': '#3B82F6',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F7F7F7; }
        .container { max-width: 1000px; margin: 20px auto; padding: 30px; background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .nav-link { padding: 10px 20px; border-radius: 6px; font-weight: bold; transition: background-color 0.3s; text-decoration: none; display: inline-block; text-align: center; }
        .form-group label { font-weight: 600; display: block; margin-bottom: 5px; color: #374151; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        .required-label::after { content: ' *'; color: #EF4444; }

        .btn-submit { padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; color: white; border: none; }
        .btn-save { background-color: #059669; } 
        .btn-save:hover { background-color: #047857; }

        .alert-danger { background-color: #FEE2E2; color: #991B1B; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #FCA5A5; }
        .alert-success { background-color: #D1FAE5; color: #065F46; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #6EE7B7; }

        .list-header { background-color: #E5E7EB; color: #374151; font-weight: bold; }
        .list-row:nth-child(even) { background-color: #F9FAFB; }
        .action-link { text-decoration: none; font-weight: 600; margin-right: 10px; }
        .delete-link { color: #EF4444; }
        
        /* Visibilidade controlada por Jinja */
        .view-content { display: none; }
        .view-content.active-view-show { display: block !important; }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="text-2xl mb-4 text-blue-800 text-center">Gest√£o de Eventos</h2>

        <!-- Mensagens do Flask (erros/sucesso) -->
        {% if error %}
            <div class="alert-danger">{{ error }}</div>
        {% endif %}
        {% if success %}
            <div class="alert-success">{{ success | safe }}</div>
        {% endif %}

        <!-- Navega√ß√£o -->
        <div class="flex space-x-4 mb-4 border-b pb-4">
            <a href="{{ url_for('cadastro_evento', view='novo') }}" 
               class="nav-link {% if active_view in ['novo', 'alterar'] %}bg-primary text-white{% else %}bg-gray-200 text-gray-800{% endif %} hover:bg-secondary">
                ‚ûï Novo
            </a>
            <a href="{{ url_for('cadastro_evento', view='consulta') }}" 
               class="nav-link {% if active_view == 'consulta' %}bg-accent text-white{% else %}bg-gray-200 text-gray-800{% endif %} hover:opacity-90">
                üîé Consulta
            </a>
            <a href="{{ url_for('cadastro_evento', view='listar') }}" 
               class="nav-link {% if active_view == 'listar' %}bg-primary text-white{% else %}bg-gray-200 text-gray-800{% endif %} hover:bg-secondary">
                üìã Listar
            </a>
        </div>

        <div class="mb-2 p-2 bg-info text-white border border-blue-600 rounded-lg">
            Total de Eventos Cadastrados: <strong id="total-eventos">{{ total_eventos | default(0) }}</strong>.
        </div>
        
        <!-- VISUALIZA√á√ÉO NOVO/ALTERAR -->
        {% set is_novo_alterar = active_view in ['novo', 'alterar'] %}
        <div id="view-novo" class="view-content {% if is_novo_alterar %}active-view-show{% endif %}">
            
            {% set evento = evento_edicao if evento_edicao is not none else {} %} 
            
            <h3 class="text-xl font-semibold mb-2 {% if active_view == 'alterar' %}text-accent{% else %}text-primary{% endif %}">
                {% if active_view == 'alterar' %}Altera√ß√£o de Evento (ID: {{ evento.get('id_evento', 'N/A') }}){% else %}Cadastro de Novo Evento{% endif %}
            </h3>

            <form method="POST" action="{{ url_for('gravar_evento') }}" 
                  id="form-cadastro" class="space-y-4" 
                  onkeydown="return preventDefaultOnEnter(event)">
                
                {% if active_view == 'alterar' %}
                    <input type="hidden" name="id_evento_edicao" value="{{ evento.get('id_evento', '') }}">
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- Linha 1: Dados B√°sicos e ID -->
                    <div class="form-group">
                        <label>ID Evento:</label>
                        <input type="text" 
                               value="{% if active_view == 'alterar' %}{{ evento.get('id_evento', 'N/A') }}{% else %}Gerado Automaticamente{% endif %}" 
                               disabled class="form-control bg-gray-100">
                    </div>
                    <div class="form-group">
                        <!-- CORRE√á√ÉO: type="date" para abrir o calend√°rio -->
                        <label for="data_evento" class="required-label">Data do Evento:</label>
                        <input type="date" id="data_evento" name="data_evento" required class="form-control" 
                               value="{{ evento.get('data_evento', '') }}"
                               {% if active_view == 'alterar' and evento.get('data_evento') %}
                                   value="{{ evento.get('data_evento') }}"
                               {% endif %}
                               >
                    </div>
                    <div class="form-group">
                        <label for="hora_evento" class="required-label">Hora do Evento (hh:mm):</label>
                        <input type="time" id="hora_evento" name="hora_evento" required class="form-control"
                               value="{{ evento.get('hora_evento', '20:00') }}">
                    </div>

                    <!-- Linha 2: Descri√ß√£o e Venda -->
                    <div class="form-group md:col-span-3">
                        <label for="descricao" class="required-label">Descri√ß√£o do Evento:</label>
                        <input type="text" id="descricao" name="descricao" required class="form-control" 
                               value="{{ evento.get('descricao', '') }}">
                    </div>

                    <!-- Linha 3: Controle de Venda -->
                    <div class="form-group">
                        <label for="unidade_de_venda" class="required-label">Unidade de Venda (1-6):</label>
                        <input type="number" id="unidade_de_venda" name="unidade_de_venda" required min="1" max="6" class="form-control"
                               value="{{ evento.get('unidade_de_venda', 6) }}" oninput="calculatePremioTotal()">
                    </div>
                    <div class="form-group">
                        <label for="valor_de_venda" class="required-label">Valor da Unidade (R$):</label>
                        <!-- CORRE√á√ÉO: Valor monet√°rio padronizado para 0.00 -->
                        <input type="number" id="valor_de_venda" name="valor_de_venda" required step="0.01" min="0" class="form-control"
                               value="{{ evento.get('valor_de_venda', ) }}" oninput="calculatePremioTotal()">
                    </div>

                    <!-- Linha 4: Controle de Cartelas -->
                    <div class="form-group">
                        <label for="numero_inicial" class="required-label">N√∫mero Inicial da Cartela:</label>
                        <input type="number" id="numero_inicial" name="numero_inicial" required min="1" class="form-control"
                               value="{{ evento.get('numero_inicial', 1) }}">
                    </div>
                    <div class="form-group">
                        <label for="numero_maximo" class="required-label">N√∫mero M√°ximo da Cartela:</label>
                        <input type="number" id="numero_maximo" name="numero_maximo" required min="1" class="form-control"
                               value="{{ evento.get('numero_maximo', 72000) }}">
                    </div>

                    <!-- Linha 5: Pr√™mios (Linha 1) -->
                    <div class="form-group">
                        <label for="premio_quadra" class="required-label">Pr√™mio Quadra (R$):</label>
                        <!-- CORRE√á√ÉO: Se vazio, use 0.00 -->
                        <input type="number" id="premio_quadra" name="premio_quadra" required step="0.01" min="0" class="form-control"
                               value="{{ evento.get('premio_quadra', ) }}" oninput="calculatePremioTotal()">
                    </div>
                    <div class="form-group">
                        <label for="quantidade_de_linhas" class="required-label">Qtde. de Linhas (1-3):</label>
                        <input type="number" id="quantidade_de_linhas" name="quantidade_de_linhas" required min="1" max="3" class="form-control"
                               value="{{ evento.get('quantidade_de_linhas', 1) }}" oninput="calculatePremioTotal()">
                    </div>
                    <div class="form-group">
                        <label for="premio_linha" class="required-label">Pr√™mio por Linha (R$):</label>
                        <!-- CORRE√á√ÉO: Se vazio, use 0.00 -->
                        <input type="number" id="premio_linha" name="premio_linha" required step="0.01" min="0" class="form-control"
                               value="{{ evento.get('premio_linha', ) }}" oninput="calculatePremioTotal()">
                    </div>

                    <!-- Linha 6: Pr√™mios (Linha 2) e Acumulado -->
                    <div class="form-group">
                        <label for="premio_bingo" class="required-label">Pr√™mio Bingo (R$):</label>
                        <!-- CORRE√á√ÉO: Se vazio, use 0.00 -->
                        <input type="number" id="premio_bingo" name="premio_bingo" required step="0.01" min="0" class="form-control"
                               value="{{ evento.get('premio_bingo', ) }}" oninput="calculatePremioTotal()">
                    </div>
                    <div class="form-group">
                        <label for="premio_segundobingo">Pr√™mio Segundo Bingo (R$):</label>
                        <!-- CORRE√á√ÉO: Se vazio, use 0.00 -->
                        <input type="number" id="premio_segundobingo" name="premio_segundobingo" step="0.01" min="0" class="form-control"
                               value="{{ evento.get('premio_segundobingo', ) }}" oninput="calculatePremioTotal()">
                    </div>
                    <div class="form-group">
                        <label for="minimo_de_venda">M√≠nimo de Venda Necess√°rio (Qtde):</label>
                        <!-- Este campo ser√° calculado automaticamente -->
                        <input type="text" id="minimo_de_venda" name="minimo_de_venda" disabled class="form-control bg-gray-200"
                               value="{{ evento.get('minimo_de_venda', 0) }}">
                    </div>
                    <!-- Linha 7: Total e Bola Tope -->
                    <div class="form-group">
                        <label for="premio_total">Pr√™mio TOTAL (R$):</label>
                        <input type="text" id="premio_total" name="premio_total" disabled class="form-control bg-gray-200 font-bold"
                               value="{{ evento.get('premio_total', 0.00) }}">
                    </div>

                    <div class="form-group">
                        <label for="premio_acumulado">Pr√™mio Acumulado (R$):</label>
                        <!-- CORRE√á√ÉO: Se vazio, use 0.00 -->
                        <input type="number" id="premio_acumulado" name="premio_acumulado" step="0.01" min="0" class="form-control"
                               value="{{ evento.get('premio_acumulado', ) }}" oninput="toggleBolaTope(); calculatePremioTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label for="bola_tope_acumulado" id="label_bola_tope" 
                               class="{% if evento.get('premio_acumulado', 0) <= 0 %}text-gray-400{% endif %}">Bola Tope Acumulado (2 d√≠gitos):</label>
                        <input type="number" id="bola_tope_acumulado" name="bola_tope_acumulado" min="1" max="99" class="form-control"
                               value="{{ evento.get('bola_tope_acumulado', '') }}" 
                               {% if evento.get('premio_acumulado', 0) <= 0 %}disabled{% endif %}>
                    </div>

                    <div class="form-group">
                        <label for="tipo_de_cartela" class="required-label">Tipo de Cartela:</label>
                        {% set valor_selecionado = evento.get('tipo_de_cartela', 15) | int %}            
                        <select id="tipo_de_cartela" name="tipo_de_cartela" required class="form-control">
                              <option value="15" {% if valor_selecionado == 15 %}selected{% endif %}>
                                     15 N√∫meros
                              </option>
                              <option value="25" {% if valor_selecionado == 25 %}selected{% endif %}>
                                      25 N√∫meros
                              </option>
                        </select>
                    </div>

                    <div class="form-group">
                         <label for="status">Status (Autom√°tico):</label>
                        <input type="text" id="status" name="status" disabled class="form-control bg-gray-100 font-semibold text-red-500"
                               value="{% if active_view == 'alterar' %}{{ evento.get('status', 'Paralizado') }}{% else %}Paralizado (Padr√£o){% endif %}">
                    </div>

                </div>
                
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="submit" class="btn-submit btn-save">
                        {% if active_view == 'alterar' %}
                            ‚úì Salvar Altera√ß√µes
                        {% else %}
                            üíæ Salvar Evento
                        {% endif %}
                    </button>
                    {% if active_view == 'alterar' %}
                        <a href="{{ url_for('cadastro_evento', view='listar') }}" class="nav-link bg-gray-400 text-white hover:bg-gray-500">Cancelar</a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- VISUALIZA√á√ÉO CONSULTA -->
        <div id="view-consulta" class="view-content {% if active_view == 'consulta' %}active-view-show{% endif %}">
            <h3 class="text-xl font-semibold mb-4 text-accent">Consulta de Evento</h3>
            <form method="GET" action="{{ url_for('cadastro_evento') }}" class="mb-4 space-y-2">
                <input type="hidden" name="view" value="consulta">
                <label for="consulta_termo" class="form-group">Buscar por ID, Data ou Descri√ß√£o:</label>
                <div class="flex space-x-2">
                    <input type="text" id="consulta_termo" name="query" value="{{ query | default('') }}" placeholder="Digite o termo de busca..." class="form-control mb-0">
                    <button type="submit" class="nav-link bg-accent text-white hover:opacity-90 min-w-[100px]">Buscar</button>
                </div>
            </form>
            
            <div class="mt-6 p-4 border rounded-lg bg-gray-50">
                {% if active_view == 'consulta' and query and eventos_lista|length > 0 %}
                    <h4 class="font-bold mb-3">{{ eventos_lista | length }} Resultado(s) encontrado(s) para "{{ query }}"</h4>
                    {% for evento in eventos_lista %}
                        <div class="border-b pb-3 mb-3 last:border-b-0 last:mb-0">
                            <p><strong>ID:</strong> {{ evento.id_evento }}</p>
                            <p><strong>Descri√ß√£o:</strong> <span class="font-semibold text-primary">{{ evento.descricao }}</span></p>
                            <p><strong>Data/Hora:</strong> {{ evento.data_evento | default('N/A') }} √†s {{ evento.hora_evento | default('N/A') }}</p>
                            <p><strong>Pr√™mio Total:</strong> R$ {{ evento.premio_total | default(0.00) | round(2) }} | <strong>Status:</strong> {{ evento.status }}</p>
                            <div class="mt-2 flex space-x-3">
                                <a href="{{ url_for('cadastro_evento', view='alterar', id_evento=evento.id_evento) }}" class="action-link text-blue-500 hover:text-blue-700">Alterar</a>
                                
                                <form method="POST" action="{{ url_for('excluir_evento', id_evento=evento.id_evento) }}" 
                                      class="inline-block"
                                      onsubmit="return confirm('ATEN√á√ÉO: Confirma a exclus√£o do evento ID {{ evento.id_evento }}? Esta a√ß√£o √© IRREVERS√çVEL.')">
                                    <button type="submit" class="action-link delete-link hover:text-red-600">Excluir</button>
                                </form>

                            </div>
                        </div>
                    {% endfor %}
                {% elif active_view == 'consulta' and query and eventos_lista|length == 0 %}
                    <p class="text-center text-red-500 font-bold">‚ùå Nenhum evento encontrado para o termo "{{ query }}".</p>
                {% else %}
                    <p class="text-gray-500 text-center">Utilize o campo acima para buscar um evento.</p>
                {% endif %}
            </div>
        </div>

        <!-- VISUALIZA√á√ÉO LISTAR -->
        <div id="view-listar" class="view-content {% if active_view == 'listar' %}active-view-show{% endif %}">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Lista de Eventos (Ordenada por Data)</h3>
            
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="list-header">
                            <th class="py-2 px-4 border-b text-left">ID</th>
                            <th class="py-2 px-4 border-b text-left">Descri√ß√£o</th>
                            <th class="py-2 px-4 border-b text-left">Data/Hora</th>
                            <th class="py-2 px-4 border-b text-left">Pr√™mio Total</th>
                            <th class="py-2 px-4 border-b text-left">Status</th>
                            <th class="py-2 px-4 border-b text-left">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if active_view == 'listar' and eventos_lista %}
                            {% for evento in eventos_lista %}
                            <tr class="list-row hover:bg-gray-100 transition duration-150">
                                <td class="py-3 px-4 border-b text-sm">{{ evento.id_evento }}</td>
                                <td class="py-3 px-4 border-b text-sm">{{ evento.descricao }}</td>
                                <td class="py-3 px-4 border-b text-sm">{{ evento.data_evento | default('N/A') }} √†s {{ evento.hora_evento | default('N/A') }}</td>
                                <td class="py-3 px-4 border-b text-sm font-semibold">R$ {{ evento.premio_total | default(0.00) | round(2) }}</td>
                                <td class="py-3 px-4 border-b text-sm">{{ evento.status }}</td>
                                <td class="py-3 px-4 border-b text-sm whitespace-nowrap">
                                    <a href="{{ url_for('cadastro_evento', view='alterar', id_evento=evento.id_evento) }}" class="action-link text-blue-500 hover:text-blue-700">Alterar</a>
                                    
                                    <form method="POST" action="{{ url_for('excluir_evento', id_evento=evento.id_evento) }}" 
                                          class="inline-block"
                                          onsubmit="return confirm('ATEN√á√ÉO: Confirma a exclus√£o do evento ID {{ evento.id_evento }}? Esta a√ß√£o √© IRREVERS√çVEL.')">
                                        <button type="submit" class="action-link delete-link hover:text-red-600">Excluir</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="6" class="py-8 text-center text-gray-500 font-bold">Nenhum evento cadastrado.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="flex justify-center mt-8">
            <a href="{{ url_for('menu_operacoes') }}" class="text-primary hover:text-secondary font-medium">‚Üê Voltar ao Menu de Opera√ß√µes</a>
        </div>
        
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            calculatePremioTotal();
            toggleBolaTope();
        });
        
        // CORRE√á√ÉO: Fun√ß√£o para evitar submiss√£o do formul√°rio ao pressionar Enter.
        function preventDefaultOnEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Opcional: mover o foco para o pr√≥ximo campo ou para o bot√£o de salvar.
                return false; 
            }
        }

        // Fun√ß√£o que calcula o pr√™mio total e o m√≠nimo de venda
        function calculatePremioTotal() {
            // Usa o operador nullish-coalescing (??) para pegar o valor ou 0
            const quadra = parseFloat(document.getElementById('premio_quadra')?.value) || 0;
            const linhas_qtde = parseInt(document.getElementById('quantidade_de_linhas')?.value) || 0;
            const linha_valor = parseFloat(document.getElementById('premio_linha')?.value) || 0;
            const bingo = parseFloat(document.getElementById('premio_bingo')?.value) || 0;
            const segundobingo = parseFloat(document.getElementById('premio_segundobingo')?.value) || 0;
            const acumulado = parseFloat(document.getElementById('premio_acumulado')?.value) || 0; // Inclu√≠do Acumulado no c√°lculo

            const valor_unidade = parseFloat(document.getElementById('valor_de_venda')?.value) || 0;
            const unidade_venda = parseInt(document.getElementById('unidade_de_venda')?.value) || 1;

            // 1. C√°lculo do Pr√™mio Total
            const totalLinha = linhas_qtde * linha_valor;
            const premioTotal = quadra + totalLinha + bingo + segundobingo + acumulado; // Adicionado acumulado
            
            // 2. C√°lculo do M√≠nimo de Venda Necess√°rio
            let minimoVenda = 0;
            if (valor_unidade > 0 && unidade_venda > 0) {
                 minimoVenda = premioTotal / (valor_unidade * unidade_venda);
            }
            
            // Atualiza os campos
            document.getElementById('premio_total').value = premioTotal.toFixed(2);
            document.getElementById('minimo_de_venda').value = Math.ceil(minimoVenda); // Arredonda para cima para garantir cobertura
            
            // Chama o toggle para garantir que o campo bola tope se atualize
            toggleBolaTope();
        }
        // NOVO: Fun√ß√£o que dispara a confirma√ß√£o e submete o formul√°rio se confirmado
        function confirmDelete(nick, id_cliente) {
            const message = `ATEN√á√ÉO: Confirma a exclus√£o de ${nick} (CLI${id_cliente})? Esta a√ß√£o √© IRREVERS√çVEL.`;
            
            // Usa o confirm padr√£o do navegador
            if (window.confirm(message)) {
                // Se confirmado, encontra o formul√°rio (ID din√¢mico) e o submete
                // Checa primeiro o ID da consulta, depois o da lista
                let form = document.getElementById(`form-excluir-${id_cliente}`);
                if (!form) {
                    form = document.getElementById(`form-excluir-list-${id_cliente}`);
                }
                
                if (form) {
                    form.submit();
                }
            }
        }
        // Fun√ß√£o que ativa/desativa o campo Bola Tope
        function toggleBolaTope() {
            const acumulado = parseFloat(document.getElementById('premio_acumulado')?.value) || 0;
            const bolaTopeInput = document.getElementById('bola_tope_acumulado');
            const bolaTopeLabel = document.getElementById('label_bola_tope');

            if (acumulado > 0) {
                bolaTopeInput.disabled = false;
                bolaTopeInput.setAttribute('required', 'required');
                bolaTopeLabel.classList.remove('text-gray-400');
                bolaTopeLabel.classList.add('required-label');
            } else {
                bolaTopeInput.disabled = true;
                bolaTopeInput.removeAttribute('required');
                bolaTopeInput.value = ''; // Limpa o valor
                bolaTopeLabel.classList.add('text-gray-400');
                bolaTopeLabel.classList.remove('required-label');
            }
        }
        
        // Fun√ß√£o para simular o confirm para ambientes que bloqueiam window.confirm (se necess√°rio)
        function confirm(message) {
            return window.confirm(message);
        }
        
    </script>
</body>
</html>
